seajs.use(["common/ui/Upload","common/common","common/ui/Table","common/ui/locale/zh-CN","plugin/moment","common/ui/extensions/form","plugin/select2.min","common/ui/extensions/table-fixed-tools"],function(e){var a;window.location.hash&&$('#pageTabs a[href="'+window.location.hash+'"]').tab("show"),$("select[name='auto_ou'],select[name='auto_ou1'],select[name='auto_ou2']").select2({theme:"bootstrap",language:{noResults:function(){return"未找到结果"},searching:function(){return"搜索中…"}},ajax:{url:"/GetDataOfOuSearch",dataType:"json",processResults:function(t){return{results:t.items}}}}),$("#table").Table({url:"/VoucherVatShallBe",columns:[{field:"state",checkbox:!0},{field:"Serial",title:"序号",align:"left"},{field:"OANO",title:"OA系统单号","class":"text-nowrap",halign:"right"},{field:"Certigier",title:"OU"},{field:"NO",title:"发票号",formatter:function(t,e,a){return'<a href="InvoiceDetail.html?id='+e.ID+'" target="_blank" title="查看详情">'+t+"</a>"}},{field:"NotTaxMoney",title:"不含税金额",align:"right",halign:"center",format:"price"},{field:"TaxMoney",title:"含税金额",align:"right",halign:"center",format:"price"},{field:"Taxlines",title:"税额",align:"right",halign:"center",format:"price"},{field:"SupplierName",title:"供应商名称",width:150,textOverflow:!0},{field:"LocationName",title:"导单地点"},{field:"CertificationDate",title:"认证日期",format:"datetime",dateTimeFormatter:"YYYY-M-D"},{field:"id",title:"操作",formatter:function(t,e,a){return'<a href="javascript:void(0);" title="删除" class="btn-delSingle" data-id='+t+'><i class="ficon ficon-delete"></i></a>'},"class":"td-option"}]}),$("#tbBatch").Table({url:"/GetListBatch",columns:[{field:"state",checkbox:!0},{field:"NO",title:"批号",width:240,formatter:function(t,e,a){return'<a href="BatchDetail.html?id='+e.ID+'" target="_blank" title="查看详情">'+t+"</a>"}},{field:"BatchTypeName",title:"凭证类型","class":"text-nowrap"},{field:"Certigier",title:"OU"},{field:"StubCount",title:"发票数量"},{field:"CreateDateTime",title:"创批时间",formatter:function(t,e,a){return moment(t).format("YYYY-M-D")},"class":"text-nowrap"},{field:"ID",title:"操作",formatter:function(t,e,a){return'<a href="javascript:void(0);" title="删除" class="btn-delSingle" data-id='+t+'><i class="ficon ficon-delete"></i></a><a href="print?id='+t+'" title="打印"><i class="ficon ficon-printer"></i></a>'},"class":"td-option"}]}),$("#tbVolumn").Table({url:"/GetListVolumn",columns:[{field:"state",checkbox:!0},{field:"NO",title:"本号",width:200,formatter:function(t,e,a){return'<a href="VolumnDetail.html?id='+e.ID+'" target="_blank" title="查看详情">'+t+"</a>"}},{field:"ResidsOUName",title:"所属OU"},{field:"CreateDateTime",title:"创本时间",formatter:function(t,e,a){return moment(t).format("YYYY-M-D")},"class":"text-nowrap"},{field:"ID",title:"操作",formatter:function(t,e,a){return'<a href="javascript:void(0);" title="删除" class="btn-delSingle" data-id='+t+'><i class="ficon ficon-delete"></i></a><a href="print?id='+t+'" title="打印"><i class="ficon ficon-printer"></i></a>'},"class":"td-option"}]}),$list=$("#filesList"),$btn=$("#uploadBtn"),state="pending",$("#import").click(function(){if($("#importModal").modal({keyboard:!1}),a)return!1;(a=e.create({resize:!1,swf:"./dist/js/plugin/Uploader.swf",server:"./upload",pick:"#picker",fileNumLimit:1,accept:{title:"intoTypes",extensions:"xls,xlsx",mimeTypes:"application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}})).on("fileQueued",function(t){$list.append('<tr id="'+t.id+'" class="template-upload fade"><td class="text-left"><p class="name">'+t.name+'</p><strong class="error text-danger"></strong></td><td><p class="size">'+e.formatSize(t.size)+'</p><div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><div class="progress-bar progress-bar-success" style="width:0%;"></div></div></td><td><p class="state">等待上传...</p></td><td class="text-right"><button class="btn btn-red cancel">取消</button></td></tr>'),$btn.css("display",""),$("#"+t.id).find(".cancel").on("click",function(){a.removeFile(t.id,!0),$("#"+t.id).remove()})}),a.on("fileDequeued",function(t){1===$list.find("tr").size()&&$btn.hide()}),a.on("uploadProgress",function(t,e){var a=$("#"+t.id),i=a.find(".progress .progress-bar");i.length||(i=$('<div class="progress progress-striped active"><div class="progress-bar" role="progressbar" style="width: 0%"></div></div>').appendTo(a).find(".progress-bar")),a.find("p.state").text("上传中"),i.css("width",100*e+"%")}),a.on("uploadSuccess",function(t){$("#"+t.id).find("p.state").text("上传成功")}),a.on("uploadError",function(t){$("#"+t.id).find("p.state").text("上传出错")}),a.on("uploadComplete",function(t){$("#"+t.id).find(".progress").fadeOut(),$("#"+t.id).find(".cancel").css("visibility","hidden"),$btn.hide()}),a.on("all",function(t){"startUpload"===t?state="uploading":"stopUpload"===t?state="paused":"uploadFinished"===t&&(state="done"),"uploading"===state?$btn.text("暂停上传"):$btn.text("开始上传")}),a.on("reset",function(){$list.html(""),$btn.hide()}),$btn.on("click",function(){"uploading"===state?a.stop():a.upload()})}),$("#save").click(function(){var t=$(this).button("loading");setTimeout(function(){t.button("reset"),$("#importModal").modal("hide"),$("#table").Table("refresh")},1e3)}),$("#cancel").click(function(){if(!a)return!1;a.reset()}),$("#next").click(function(){var t=$(this).button("loading");setTimeout(function(){t.button("reset"),$("#importModal").modal("hide"),$("#table").Table("refreshOptions",{pageSize:20}),$("#table").Table("refresh",{query:{foo:"bar"}})},1e3)}),$(".btn-deliver").click(function(){$("#deliverModal").modal();$("select[name='auto_dataUser']").select2({theme:"bootstrap",language:{noResults:function(){return"未找到结果"},searching:function(){return"搜索中…"}},ajax:{url:"http://hrc.oa.com/v1.1/pages/chooser/data/staff.aspx?deptlevel=-1&depttypeid=-1",dataType:"jsonp",data:function(t){return{q:t.term}},processResults:function(t){for(var e=[],a=0;a<t.length;a++){var i=t[a];e.push({id:i.ID,text:i.Name})}return{results:e}}}})}),$(".btn-deliver-batch").click(function(){$("#deliverBatchModal").modal()}),$(".btn-submit-volumn").click(function(){$("#submitVolumnModal").modal()}),$(".btn-addListBatch").click(function(){var a=$("#table").Table("getSelections"),i=!0,n=!0;if($("#textOU").val(""),$("#textLocation").val(""),1<a.length&&$.each(a,function(t,e){e.OU!=a[0].OU&&(i=!1),e.LocationName!=a[0].LocationName&&(n=!1)}),!i||!n)return alert("选中列必须OU和导单地址相同"),!1;$("#textOU").val(a[0].Certigier),$("#textLocation").val(a[0].LocationName),$("#addListBatchModal").modal({keyboard:!1})}),$(".btn-addListVolumn").click(function(){var a=$("#tbBatch").Table("getSelections"),i=!0,n=[],l=$("#addListVolumnModal");if($("#textBatchOU").val(""),0<a.length&&$.each(a,function(t,e){e.OU!=a[0].OU&&(i=!1),n.push('<div class="btn btn-default" data-no='+e.NO+">"+e.NO+' <span aria-hidden="true">&times;</span></div>')}),!i)return alert("选中列必须OU相同"),!1;$("#choosedBatch").html(n.join("")),$("#choosedBatch").on("click","span",function(){var t=$(this).parent(),e=t.data("no");$("#tbBatch").Table("uncheckBy",{field:"NO",values:[e]}),t.remove(),(a=$("#tbBatch").Table("getSelections")).length<1&&l.modal("hide")}),$("#textBatchOU").val(a[0].Certigier),l.modal({keyboard:!1})}),$(".btn-delListChecked").click(function(){var t="您确定要删除当前所选的"+$("#table").Table("getSelections").length+"条记录吗？";if(confirm(t)){var e=$(".btn-delListChecked").button("loading");setTimeout(function(){e.button("reset"),$("#table").Table("refresh")},1e3)}}),$("#checkAllSearch").click(function(){$(this)[0].checked?$("#table").Table("checkAll"):$("#table").Table("uncheckAll")}),$("#table").on("load-success.bs.table page-change.bs.table",function(){$("#checkAllSearch")[0].checked&&$(this).Table("checkAll")}),$("#saveListBatch").click(function(){var t=$(this).button("loading");setTimeout(function(){t.button("reset"),$("#addListBatchModal").modal("hide"),$('#pageTabs a[href="#batch"]').tab("show")},1e3)}),$("#saveListVolumn").click(function(){var t=$(this).button("loading");setTimeout(function(){t.button("reset"),$("#addListVolumnModal").modal("hide"),$('#pageTabs a[href="#volumn"]').tab("show")},1e3)}),$.fn.searchTable=function(t){var e=$(this),a="object"==typeof t&&t;if(a&&a.table&&a.form){var i=e.button("loading");setTimeout(function(){i.button("reset"),$(a.table).Table("refresh",{query:$(a.form).serializeObject()})},500)}else console.log("未找到table或form，请检查参数")},$("#btnSearchVat").click(function(){$(this).searchTable({table:"#table",form:"#formSearchVat"})}),$("#btnSearchBatch").click(function(){$(this).searchTable({table:"#tbBatch",form:"#formSearchBatch"})}),$("#btnSearchVolumn").click(function(){$(this).searchTable({table:"#tbVolumn",form:"#formSearchVolumn"})}),$(".bootstrap-table").on("click",".btn-delSingle",function(t){confirm("您确定要删除这条记录吗？")&&$(this).parents("table").Table("refresh")})});