define(function(require,exports,module){var $=require("plugin/jquery");require("plugin/select2.min"),function($){"use strict";var d=$.fn.Table.utils.sprintf,e=$.fn.Table.utils.objectKeys,g=function(t){return t.get(t.length-1).options},v=function(t,e,o){e=$.trim(e),t=$(t.get(t.length-1)),i(t,e)||t.append($("<option></option>").attr("value",e).text($("<div />").html(o).text()))},b=function(t){var e=t.find("option:gt(0)");e.sort(function(t,e){return t=$(t).text().toLowerCase(),e=$(e).text().toLowerCase(),$.isNumeric(t)&&$.isNumeric(e)&&(t=parseFloat(t),e=parseFloat(e)),e<t?1:t<e?-1:0}),t.find("option:gt(0)").remove(),t.append(e)},i=function(t,e){for(var o=g(t),i=0;i<o.length;i++)if(o[i].value===e.toString())return!0;return!1},s=function(t){var e=t.$header;return t.options.height&&(e=t.$tableHeader),e},f=function(t){var e="select, input";return t.options.height&&(e="table select, table input"),e},n=function(t){var e=s(t),o=f(t);t.options.valuesFilterControl=[],e.find(o).each(function(){t.options.valuesFilterControl.push({field:$(this).closest("[data-field]").data("field"),value:$(this).val(),position:function(t){if($.fn.Table.utils.isIEBrowser()){if($(t).is("input")){var e=0;if("selectionStart"in t)e=t.selectionStart;else if("selection"in document){t.focus();var o=document.selection.createRange(),i=document.selection.createRange().text.length;o.moveStart("character",-t.value.length),e=o.text.length-i}return e}return-1}return-1}($(this).get(0))})})},c=function(n){var r=null,a=[],t=s(n),e=f(n);0<n.options.valuesFilterControl.length&&t.find(e).each(function(t,e){var o,i;r=$(this).closest("[data-field]").data("field"),0<(a=$.grep(n.options.valuesFilterControl,function(t){return t.field===r})).length&&($(this).val(a[0].value),o=$(this).get(0),i=a[0].position,$.fn.Table.utils.isIEBrowser()&&(o.setSelectionRange!==undefined?o.setSelectionRange(i,i):$(o).val(o.value)))})},t=function(u){var p=u.data,h=(u.pageTo<u.options.data.length?u.options.data.length:u.pageTo,u.options.pagination?"server"===u.options.sidePagination?u.pageTo:u.options.totalRows:u.pageTo);$.each(u.header.fields,function(t,e){var o,i,n,r=u.columns[$.fn.Table.utils.getFieldIndex(u.columns,e)],a=$("select.bootstrap-table-filter-control-"+m(r.field));if((n=r).filterControl&&"select"===n.filterControl.toLowerCase()&&n.searchable&&((i=r).filterData===undefined||"column"===i.filterData.toLowerCase())&&((o=a)&&0<o.length)){0===a.get(a.length-1).options.length&&v(a,"",r.filterTitle);for(var l={},s=0;s<h;s++){var f=p[s][e];l[$.fn.Table.utils.calculateObjectValue(u.header,u.header.formatters[t],[f,p[s],s],f)]=f}for(var c in l)v(a,l[c],c);b(a),u.options.hideUnusedSelectOptions&&function(t,e){for(var o=g(t),i=0;i<o.length;i++)""!==o[i].value&&(e.hasOwnProperty(o[i].value)?t.find(d("option[value='%s']",o[i].value)).show():t.find(d("option[value='%s']",o[i].value)).hide())}(a,l),$(a).select2({theme:"bootstrap",language:{noResults:function(){return"未找到结果"}}}),$(a).parents(".th-inner").addClass("has-filter"),$(a).parents(".bootstrap-table").addClass("has-filter")}})},m=function(t){return String(t).replace(/(:|\.|\[|\]|,)/g,"\\$1")},o=function(s,f){var c,u,p=!1,o=0;$.each(s.columns,function(t,o){if(c="hidden",u=[],o.visible){if(o.filterControl){u.push('<div class="filter-control">');var e=o.filterControl.toLowerCase();o.searchable&&s.options.filterTemplate[e]&&(p=!0,c="visible",u.push(s.options.filterTemplate[e](s,o.field,c,o.filterControlPlaceholder)))}else;if($.each(f.children().children(),function(t,e){if((e=$(e)).data("field")===o.field)return e.find(".th-inner").append(u.join("")),"input"===o.filterControl&&e.find(".th-inner").addClass("has-search").append('<span class="search-control">[ 筛选 ]</span>'),!1}),o.filterData!==undefined&&"column"!==o.filterData.toLowerCase()){var i,n,r,a,l=y(h,o.filterData.substring(0,o.filterData.indexOf(":")));if(null===l)throw new SyntaxError('Error. You should use any of these allowed filter data methods: var, json, url. Use like this: var: {key: "value"}');switch(i=o.filterData.substring(o.filterData.indexOf(":")+1,o.filterData.length),n=$("select.bootstrap-table-filter-control-"+m(o.field)),v(n,"",""),l(i,n),l){case"url":$.ajax({url:i,dataType:"json",success:function(t){for(var e in t)v(n,e,t[e]);b(n)}});break;case"var":for(a in r=window[i])v(n,a,r[a]);b(n);break;case"jso":for(a in r=JSON.parse(i))v(n,a,r[a]);b(n)}}}}),p?(f.off("keyup","input").on("keyup","input",function(t){clearTimeout(o),o=setTimeout(function(){s.onColumnSearch(t)},s.options.searchTimeOut)}),f.off("change","select").on("change","select",function(t){clearTimeout(o),o=setTimeout(function(){s.onColumnSearch(t)},s.options.searchTimeOut)}),f.off("mouseup","input").on("mouseup","input",function(t){var e=$(this);""!==e.val()&&setTimeout(function(){""===e.val()&&(clearTimeout(o),o=setTimeout(function(){s.onColumnSearch(t)},s.options.searchTimeOut))},1)}),f.off("click",".search-control").on("click",".search-control",function(t){var e=$(this),o=e.siblings(".filter-control"),i=o.find("input");o.hasClass("show")?(o.removeClass("show"),e.text("[ 筛选 ]")):(o.addClass("show"),e.text("取消")),i.val("").keyup().mouseup(),$(document).mouseup(function(t){var e=t.target;e&&o.hasClass("show")&&o.get(0)!==e&&0==o.get(0).contains(e)&&o.removeClass("show")})}),0<f.find(".date-filter-control").length&&$.each(s.columns,function(t,e){e.filterControl!==undefined&&"datepicker"===e.filterControl.toLowerCase()&&f.find(".date-filter-control.bootstrap-table-filter-control-"+e.field).datepicker(e.filterDatepickerOptions).on("changeDate",function(t){$(d(".%s",t.currentTarget.classList.toString().split(" ").join("."))).val(t.currentTarget.value),$(t.currentTarget).keyup()})})):f.find(".filterControl").hide()},h={"var":function(t,e){var o=window[t];for(var i in o)v(e,i,o[i]);b(e)},url:function(t,o){$.ajax({url:t,dataType:"json",success:function(t){for(var e in t)v(o,e,t[e]);b(o)}})},json:function(t,e){var o=JSON.parse(t);for(var i in o)v(e,i,o[i]);b(e)}},y=function(t,e){for(var o=Object.keys(t),i=0;i<o.length;i++)if(o[i]===e)return t[e];return null};$.extend($.fn.Table.defaults,{filterControl:!1,onColumnSearch:function(t,e){return!1},filterShowClear:!1,alignmentSelectControlOptions:undefined,filterTemplate:{input:function(t,e,o,i){return d('<input type="text" class="form-control bootstrap-table-filter-control-%s" style="width: 100%; visibility: %s" placeholder="%s">',e,o,i)},select:function(t,e,o){return d('<select class="form-control bootstrap-table-filter-control-%s" style="width: 100%; visibility: %s" dir="%s"></select>',e,o,function(t){switch(t=t===undefined?"left":t.toLowerCase()){case"left":return"ltr";case"right":return"rtl";case"auto":return"auto";default:return"ltr"}}(t.options.alignmentSelectControlOptions))},datepicker:function(t,e,o){return d('<input type="text" class="form-control date-filter-control bootstrap-table-filter-control-%s" style="width: 100%; visibility: %s">',e,o)}},valuesFilterControl:[]}),$.extend($.fn.Table.COLUMN_DEFAULTS,{filterControl:undefined,filterData:undefined,filterDatepickerOptions:undefined,filterStrictSearch:!1,filterStartsWithSearch:!1,filterControlPlaceholder:""}),$.extend($.fn.Table.Constructor.EVENTS,{"column-search.bs.table":"onColumnSearch"}),$.extend($.fn.Table.defaults.icons,{clear:"glyphicon-trash icon-clear"}),$.extend($.fn.Table.locales,{formatClearFilters:function(){return"Clear Filters"}}),$.extend($.fn.Table.defaults,$.fn.Table.locales);var r=$.fn.Table.Constructor,a=r.prototype.init,l=r.prototype.initToolbar,u=r.prototype.initHeader,p=r.prototype.initBody,C=r.prototype.initSearch;r.prototype.init=function(){if(this.options.filterControl){var t=this;Object.keys||e(),this.options.valuesFilterControl=[],this.$el.on("reset-view.bs.table",function(){t.options.height&&(0<t.$tableHeader.find("select").length||0<t.$tableHeader.find("input").length||o(t,t.$tableHeader))}).on("post-header.bs.table",function(){c(t)}).on("post-body.bs.table",function(){t.options.height&&t.$tableHeader.css("height","77px")}).on("column-switch.bs.table",function(){c(t)})}a.apply(this,Array.prototype.slice.apply(arguments))},r.prototype.initToolbar=function(){if(this.showToolbar=this.options.filterControl&&this.options.filterShowClear,l.apply(this,Array.prototype.slice.apply(arguments)),this.options.filterControl&&this.options.filterShowClear){var t=this.$toolbar.find(">.btn-group"),e=t.find(".filter-show-clear");e.length||(e=$(['<button class="btn btn-default filter-show-clear" ',d('type="button" title="%s">',this.options.formatClearFilters()),d('<i class="%s %s"></i> ',this.options.iconsPrefix,this.options.icons.clear),"</button>"].join("")).appendTo(t)).off("click").on("click",$.proxy(this.clearFilterControl,this))}},r.prototype.initHeader=function(){u.apply(this,Array.prototype.slice.apply(arguments)),this.options.filterControl&&o(this,this.$header)},r.prototype.initBody=function(){p.apply(this,Array.prototype.slice.apply(arguments)),t(this)},r.prototype.initSearch=function(){if(C.apply(this,Array.prototype.slice.apply(arguments)),"server"!==this.options.sidePagination){var a=this,l=$.isEmptyObject(this.filterColumnsPartial)?null:this.filterColumnsPartial;this.data=l?$.grep(this.data,function(t,e){for(var o in l){var i=a.columns[$.fn.Table.utils.getFieldIndex(a.columns,o)],n=l[o].toLowerCase(),r=t[o];if(i&&i.searchFormatter&&(r=$.fn.Table.utils.calculateObjectValue(a.header,a.header.formatters[$.inArray(o,a.header.fields)],[r,t,e],r)),i.filterStrictSearch){if(-1===$.inArray(o,a.header.fields)||"string"!=typeof r&&"number"!=typeof r||r.toString().toLowerCase()!==n.toString().toLowerCase())return!1}else if(i.filterStartsWithSearch){if(-1===$.inArray(o,a.header.fields)||"string"!=typeof r&&"number"!=typeof r||0!==(r+"").toLowerCase().indexOf(n))return!1}else if(-1===$.inArray(o,a.header.fields)||"string"!=typeof r&&"number"!=typeof r||-1===(r+"").toLowerCase().indexOf(n))return!1}return!0}):this.data}},r.prototype.initColumnSearch=function(t){if(n(this),t)for(var e in this.filterColumnsPartial=t,this.updatePagination(),t)this.trigger("column-search",e,t[e])},r.prototype.onColumnSearch=function(t){if(!(-1<$.inArray(t.keyCode,[37,38,39,40]))){n(this);var e=$.trim($(t.currentTarget).val()),o=$(t.currentTarget).closest("[data-field]").data("field");$.isEmptyObject(this.filterColumnsPartial)&&(this.filterColumnsPartial={}),e?this.filterColumnsPartial[o]=e:delete this.filterColumnsPartial[o],this.searchText+="randomText",this.options.pageNumber=1,this.onSearch(t),this.trigger("column-search",o,e)}},r.prototype.clearFilterControl=function(){if(this.options.filterControl&&this.options.filterShowClear){var o=this,t=function(){var o=[],t=document.cookie.match(/(?:bs.table.)(\w*)/g);if(t)return $.each(t,function(t,e){/./.test(e)&&(e=e.split(".").pop()),-1===$.inArray(e,o)&&o.push(e)}),o}(),e=s(o),i=e.closest("table"),n=e.find(f(o)),r=o.$toolbar.find(".search input"),a=0;if($.each(o.options.valuesFilterControl,function(t,e){e.value=""}),c(o),!(0<n.length))return;if(this.filterColumnsPartial={},$(n[0]).trigger("INPUT"===n[0].tagName?"keyup":"change"),0<r.length&&o.resetSearch(),o.options.sortName!==i.data("sortName")||o.options.sortOrder!==i.data("sortOrder")){var l=e.find(d('[data-field="%s"]',$(n[0]).closest("table").data("sortName")));0<l.length&&(o.onSort(i.data("sortName"),i.data("sortName")),$(l).find(".sortable").trigger("click"))}clearTimeout(a),a=setTimeout(function(){t&&0<t.length&&$.each(t,function(t,e){o.deleteCookie!==undefined&&o.deleteCookie(e)})},o.options.searchTimeOut)}}}($)});