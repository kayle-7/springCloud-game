define(function(require,exports,module){var $=require("plugin/jquery"),w=(require("common/ui/Follow"),"form-date-"),l="form-range-",n="form-day-",h="form-year-",p="form-month-",e="form-hour-",s="form-minute-",x="selected",i="active",b=/\-|\//g;String.prototype.toDate=function(){var t,a,e,s=this.split(b);return t=1*s[0],a=s[1]||1,e=s[2]||1,t?new Date(t,a-1,e):new Date},Date.prototype.toArray=function(){var t=this.getFullYear(),a=this.getMonth()+1,e=this.getDate();return a<10&&(a="0"+a),e<10&&(e="0"+e),[t,a,e]};var a=function(s,t){if(!s||!s.length)return this;var a={value:"",type:"auto",min:"auto",max:"auto",trigger:["change"],onShow:$.noop,onHide:$.noop},e=$.extend({},a,t||{}),i=null;if(s.get(0).type?s=(i=s).parent():i=s.find("input"),0==i.length)return this;i.prop("readonly",!0),i.parent().hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")});var r=e.type;"auto"==r&&(r=i.attr("type")||"date");var n=i.attr("id");n||(n=r+(Math.random()+"").replace("0.",""),i.attr("id",n)),$('<label for="'+n+'"></label>').addClass(w+"arrow").insertAfter(i);var h=i.val();switch(""==h&&e.value&&(i.val(e.value),h=e.value),r){case"date":case"year":case"month":var o=h.toDate().toArray();this[x]=o;break;case"time":case"hour":case"minute":var l=h.split(":"),c=l[0],v=l[1];""!=h&&c<24&&0<c?(0<v&&v<60&&"hour"!=r?1==v.length&&(v="0"+v):v="00",1==c.length&&(c="0"+c)):v=c="00",i.val([c,v].join(":")),this[x]=[c,v];break;case"date-range":case"month-range":var d=new Date,p=new Date,m=h.split(" ");if(""!=h&&1==m.length){var u=m[0].toDate();u.getTime()>d.getTime()?p=u:d=u}else d=m[0].toDate(),p=m[m.length-1].toDate();var g=d.toArray(),f=p.toArray();"date-range"==r?i.val(g.join("-")+" 至 "+f.join("-")):i.val(g.slice(0,2).join("-")+" 至 "+f.slice(0,2).join("-")),this[x]=[g,f]}var y=this,j=$("<div></div>").addClass(w+"container").delegate("a","click",function(){var t=0,a=0,e=0,s=0;switch(j.attr("data-type")){case"date":if(/prev|next/.test(this.className)){a=$(this).attr("data-month"),y[x][1]=1*a;var i=y._monthDay(y[x]),r=y[x][2],n=j.data("dayOverflow"),h=a-1<0?i[11]:a>i.length?i[0]:i[a-1];n?y[x][2]=Math.min(n,h):y[x][2]>h&&(y[x][2]=h,j.data("dayOverflow",r)),y[x]=y[x].join("-").toDate().toArray(),y.date(),j.find("."+x).get(0).href&&y.val()}else/item/.test(this.className)?(e=this.innerHTML,/\D/.test(e)?y[x]=(new Date).toArray():(e<10&&(e="0"+e),y[x][2]=e),y.val(),y.hide(),j.removeData("dayOverflow")):"month"==$(this).attr("data-type")&&y.month();break;case"date-range":if(/prev|next/.test(this.className)){a=1*$(this).attr("data-month");var o=y.el.container.data("date")||y[x][0];y.el.container.data("date",new Date(o[0],a-1,1).toArray()),y["date-range"]()}else if(/item/.test(this.className)){t=$(this).attr("data-year"),a=$(this).attr("data-month"),e=this.innerHTML,a<10&&(a="0"+a),e<10&&(e="0"+e),(l=y[x])[0].join()==l[1].join()?t+a+e>l[0].join("")?l[1]=[t,a,e]:l[0]=[t,a,e]:l=[[t,a,e],[t,a,e]],y[x]=l,y["date-range"]()}else if(/button/.test(this.className)){"ensure"==(c=$(this).attr("data-type"))?(y.val(),y._rangeSelected=y[x],y.hide()):"cancel"==c&&(y._rangeSelected&&(y[x]=y._rangeSelected),y.hide())}break;case"month-range":if(/prev|next/.test(this.className)){t=1*$(this).attr("data-year");o=y.el.container.data("date")||y[x][0];y.el.container.data("date",new Date(t,o[1],1).toArray()),y["month-range"]()}else if(/item/.test(this.className)){var l;t=$(this).attr("data-year"),a=$(this).attr("data-value"),e="01",(l=y[x])[0].join()==l[1].join()?t+a+e>l[0].join("")?l[1]=[t,a,e]:l[0]=[t,a,e]:l=[[t,a,e],[t,a,e]],y[x]=l,y["month-range"]()}else if(/button/.test(this.className)){var c;"ensure"==(c=$(this).attr("data-type"))?(y.val(),y._rangeSelected=y[x],y.hide()):"cancel"==c&&(y._rangeSelected&&(y[x]=y._rangeSelected),y.hide())}break;case"month":if(/prev|next/.test(this.className))t=$(this).attr("data-year"),y[x][0]=1*t,y.month(),j.find("."+x).get(0).href&&y.val();else if(/item/.test(this.className)){var v=$(this).attr("data-value");if(v)y[x][1]=v;else{var d=(new Date).toArray();y[x][0]=d[0],y[x][1]=d[1]}y.val(),"month"==y.type?y.hide():y.date()}else"year"==$(this).attr("data-type")&&y.year();break;case"year":/prev|next/.test(this.className)?(t=$(this).attr("data-year"),y[x][0]=1*t,y.year(),j.find("."+x).get(0).href&&y.val()):/item/.test(this.className)&&("今年"==this.innerHTML?y[x][0]=(new Date).getFullYear():y[x][0]=1*this.innerHTML,y.val(),"year"==y.type?y.hide():y.month());break;case"minute":/prev|next/.test(this.className)?(1==(s=$(this).attr("data-hour")).length&&(s="0"+s),y[x][0]=s,y.minute(),j.find("."+x).attr("href")&&y.val()):/item/.test(this.className)?(y[x]=this.innerHTML.split(":"),y.val(),y.hide()):"hour"==$(this).attr("data-type")&&y.hour();break;case"hour":/item/.test(this.className)&&(y[x][0]=this.innerHTML.split(":")[0],y.val(),"hour"==y.type?y.hide():y.minute())}});return this.el={},this.el.container=j,this.el.trigger=s,this.el.input=i,this.type=r,this.max=e.max,this.min=e.min,this.callback={show:e.onShow,hide:e.onHide,trigger:e.trigger},s.click($.proxy(function(t){this.display?this.hide():this.show(),t.preventDefault()},this)),$(document).mouseup($.proxy(function(t){var a=t&&t.target,e=this.el.container.get(0);a&&s.get(0)!=a&&0==s.get(0).contains(a)&&e!=a&&0==e.contains(a)&&this.hide()},this)),this.svg=window.addEventListener?'<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><path d="M85.876,100.5l49.537-50.526c4.089-4.215,4.089-11.049,0-15.262 c-4.089-4.218-10.719-4.218-14.808,0L63.586,92.868c-4.089,4.215-4.089,11.049,0,15.264l57.018,58.156 c4.089,4.215,10.719,4.215,14.808,0c4.089-4.215,4.089-11.049,0-15.262L85.876,100.5z"/></svg>':"",this};return a.prototype.format=function(){var t=this.type,a=this.el.input.val();if(""==a)return this;switch(t){case"date":case"year":case"month":var e=a.toDate().toArray();this[x]=e;break;case"time":case"hour":case"minute":var s=a.split(":"),i=s[0],r=s[1];2==s.length&&(0<r&&r<60&&"hour"!=t?1==r.length&&(r="0"+r):r="00",1==i.length&&(i="0"+i),this.el.input.val([i,r].join(":")),this[x]=[i,r]);break;case"date-range":case"month-range":var n=new Date,h=new Date,o=a.split(" ");3==o.length&&(n=o[0].toDate(),h=o[o.length-1].toDate(),this[x]=[n.toArray(),h.toArray()])}return this},a.prototype.val=function(){var e=this.el.input,t=this[x],a=e.val();switch(this.type){case"date":e.val(t.join("-"));break;case"month":e.val(t.slice(0,2).join("-"));break;case"year":e.val(t[0]);break;case"date-range":e.val(t[0].join("-")+" 至 "+t[1].join("-"));break;case"month-range":e.val(t[0].slice(0,2).join("-")+" 至 "+t[1].slice(0,2).join("-"));break;case"time":case"minute":e.val(t.join(":"));break;case"hour":e.val(t[0]+":00")}return e.val()!=a&&($.isArray(this.callback.trigger)?$.each(this.callback.trigger,function(t,a){e.trigger(a)}):e.trigger(this.callback.trigger)),this},a.prototype._calendar=function(t){var a="",v=t,e=this.el.input,d=this.type,p=e.attr("min")||this.min,m=e.attr("max")||this.max,s=$.map([p,m],function(t,a){return"string"==typeof t&&1==/^\d{8}$/.test(t.replace(b,""))?t=t.toDate():"object"==typeof t&&t.getTime||(t=a?new Date(9999,0,1):new Date(0,0,1)),t});p=s[0],m=s[1];var i,r=["日","一","二","三","四","五","六"],u=this._monthDay(v),g=v.join("-").toDate();a=a+'<div class="'+n+'x">'+(i="",$.each(r,function(t,a){i=i+'<span class="'+n+'item">'+a+"</span>"}),i)+"</div>";var f,y=v.join("-").toDate();y.setDate(1),2==y.getDate()&&y.setDate(0),f=y.getDay();var j=y.getMonth()-1;j<0&&(j=11);var D='data-year="'+v[0]+'" data-month="'+(y.getMonth()+1)+'"';return a=a+'<div class="'+w+'body">'+function(){for(var t="",a="",e=0;e<6;e++){t=t+'<div class="'+w+'tr">';for(var s=0;s<7;s++){if(a=w+"item col"+s,"date"==d)if(0==e&&s<f)t=t+'<span class="'+a+'">'+(u[j]-f+s+1)+"</span>";else if((r=7*e+s-f+1)<=u[y.getMonth()]){var i=new Date(v[0],y.getMonth(),r);g.getDate()==r&&(a=a+" "+x),t=p<=i&&i<=m?t+'<a href="javascript:;" '+D+' class="'+a+'">'+r+"</a>":t+'<span class="'+a+'">'+r+"</span>"}else t=t+'<span class="'+a+'">'+(r-u[y.getMonth()])+"</span>";else if("date-range"==d){var r;if(0==e&&s<f)t=t+'<span class="'+a+'">&nbsp;</span>';else if((r=7*e+s-f+1)<=u[y.getMonth()]){i=new Date(v[0],y.getMonth(),r);var n=this[x][0].join("-").toDate(),h=this[x][1].join("-").toDate(),o=i.getTime(),l=n.getTime(),c=h.getTime();l<=o&&o<=c&&(a=a+" "+x,o==l&&(a=a+" "+w+"begin"),o==c&&(a=a+" "+w+"end"),1==r?a=a+" "+w+"first":r==u[y.getMonth()]&&(a=a+" "+w+"last")),t=p<=i&&i<=m?t+'<a href="javascript:;" '+D+' class="'+a+'">'+r+"</a>":t+'<span class="'+a+'">'+r+"</span>"}else t=t+'<span class="'+a+'">&nbsp;</span>'}}t+="</div>"}return t}.call(this)+"</div>",{monthDay:u,html:a,min:p,max:m}},a.prototype._monthDay=function(t){var a=t;0==$.isArray(t)&&(a=t.toArray());var e=[31,28,31,30,31,30,31,31,30,31,30,31];return(a[0]%4==0&&a[0]%100!=0||a[0]%400==0)&&(e[1]=29),e},a.prototype._datePrevMonth=function(t){var a=t;0==$.isArray(t)&&(a=t.toArray());var e=1*a[1],s=this._monthDay(a);return 1==e?[a[0]-1,12,a[2]].join("-").toDate():s[e-2]<a[2]?[a[0],e-1,s[e-2]].join("-").toDate():[a[0],e-1,a[2]].join("-").toDate()},a.prototype._dateNextMonth=function(t){var a=t;0==$.isArray(t)&&(a=t.toArray());var e=1*a[1],s=this._monthDay(a);return 12==e?[a[0]+1,1,a[2]].join("-").toDate():s[e]<a[2]?[a[0],e+1,s[e]].join("-").toDate():[a[0],e+1,a[2]].join("-").toDate()},a.prototype.date=function(){var t=this[x],a=(t.join("-").toDate(),t[1]-1);nextMonth=1*t[1]+1;var e=this._calendar(t),s='<div class="'+w+'x">';s=s+'<div class="'+w+'head">';var i=this._datePrevMonth(t),r=i.getMonth(),n=i.getFullYear();s=new Date(n,r,e.monthDay[r])>=e.min&&i<=e.max?s+'<a href="javascript:" class="'+w+'prev" data-month="'+a+'">'+this.svg+"</a>":s+'<span class="'+w+'prev">'+this.svg+"</span>";var h=this._dateNextMonth(t),o=h.getMonth(),l=h.getFullYear();return s=(s=h>=e.min&&new Date(l,o,1)<=e.max?s+'<a href="javascript:" class="'+w+'next" data-month="'+nextMonth+'">'+this.svg+"</a>":s+'<span class="'+w+'next">'+this.svg+"</span>")+'<a href="javascript:" class="'+w+'switch" data-type="month">'+t.slice(0,2).join("-")+"</a>\t\t</div>",s+=e.html,s=new Date>=e.min&&new Date<=e.max?s+'<a href="javascript:" class="'+w+"item "+w+'now">今天</a>':s+'<span class="'+w+"item "+w+'now">今天</span>',s+="</div>",this.el.container.attr("data-type","date").html(s),this},a.prototype["date-range"]=function(){var t=this[x],a=this.el.container.data("date")||t[0];this.el.container.data("date",a);var e=a[1]-1,s=1*a[1]+1,i=this._calendar(a),r='<div class="'+l+'x">';r=r+'<div class="'+w+'head">\t\t\t<div class="'+w+'half">';var n=new Date(a[0],e-1,a[2]);r=(r=n>=i.min&&n<=i.max?r+'<a href="javascript:" class="'+w+'prev" data-month="'+e+'">'+this.svg+"</a>":r+'<span class="'+w+'prev">'+this.svg+"</span>")+'<span class="'+w+'switch">'+new Date(a[0],e,a[2]).toArray().slice(0,2).join("-")+'</span>\t\t</div>\t\t<div class="'+w+'half">';var h=new Date(a[0],a[1],1),o=new Date(a[0],s,a[2]);return r=(r=o>=i.min&&o<=i.max?r+'<a href="javascript:" class="'+w+'next" data-month="'+s+'">'+this.svg+"</a>":r+'<span class="'+w+'next">'+this.svg+"</span>")+'<span class="'+w+'switch">'+h.toArray().slice(0,2).join("-")+"</span>\t\t</div>",r=(r=(r+="</div>")+'<div class="'+l+'body"><div class="'+w+'half">'+i.html+'</div><div class="'+w+'half">'+this._calendar(h.toArray()).html+"</div></div>")+'<div class="'+l+'footer"><a href="javascript:;" class="ui_button ui_button_primary" data-type="ensure">确定</a><a href="javascript:;" class="ui_button" data-type="cancel">取消</a></div>',r+="</div>",this.el.container.attr("data-type","date-range").html(r),this},a.prototype._month=function(h){var t=this.el.input,o=t.attr("min")||this.min,l=t.attr("max")||this.max,a=$.map([o,l],function(t,a){return t="object"==typeof t&&t.getTime?t.toArray().slice(0,2).join(""):"string"==typeof t&&0==/\D/.test(t.replace(b,""))?t.replace(b,"").slice(0,6):a?"999912":"000000"});o=a[0],l=a[1];var c=["一","二","三","四","五","六","七","八","九","十","十一","十二"],v=1*h[0],d=this.type;return{html:'<div class="'+p+'body">'+function(){for(var t="",a="",e="",s=1;s<=12;s+=1){if(e=s<10?"0"+s:s+"",a=w+"item","month"==d)s==h[1]&&(a=a+" "+x);else if("month-range"==d){var i=this[x][0].slice(0,2).join(""),r=this[x][1].slice(0,2).join(""),n=v+e;i<=n&&n<=r&&(a=a+" "+x)}t=o<=v+e&&v+e<=l?t+'<a href="javascript:" class="'+a+'" data-year="'+v+'" data-value="'+e+'">'+c[s-1]+"月</a>":t+'<span class="'+a+'" data-value="'+e+'">'+c[s-1]+"月</span>"}return t}.call(this)+"</div>",min:o,max:l}},a.prototype.month=function(){var t=this[x],a=this._month(t),e=a.min,s=a.max,i='<div class="'+p+'x">',r=1*t[0];i=i+'<div class="'+w+'head">',i=r-1>=Math.floor(e/100)&&r-1<=Math.floor(s/100)?i+'<a href="javascript:" class="'+w+'prev" data-year="'+(r-1)+'">'+this.svg+"</a>":i+'<span class="'+w+'prev">'+this.svg+"</span>",i=(i=r+1>=Math.floor(e/100)&&r+1<=Math.floor(s/100)?i+'<a href="javascript:" class="'+w+'next" data-year="'+(r+1)+'">'+this.svg+"</a>":i+'<span class="'+w+'next">'+this.svg+"</span>")+'<a href="javascript:" class="'+w+'switch" data-type="year">'+r+"</a>\t\t</div>",i+=a.html;var n=(new Date).toArray().slice(0,2).join("");return i=e<=n&&n<=s?i+'<a href="javascript:" class="'+w+"item "+w+'now">今月</a>':i+'<span class="'+w+"item "+w+'now">今月</span>',i+="</div>",this.el.container.attr("data-type","month").html(i),this},a.prototype["month-range"]=function(){var t=this[x],a=this.el.container.data("date")||t[0];this.el.container.data("date",a);var e=1*a[0]-1,s=1*a[0]+1,i=this._month(a),r=i.max.slice(0,4),n=i.min.slice(0,4),h='<div class="'+l+'x">';return h=h+'<div class="'+w+'head">\t\t\t<div class="'+w+'half">',h=(h=n<=e&&e<=r?h+'<a href="javascript:" class="'+w+'prev" data-year="'+e+'">'+this.svg+"</a>":h+'<span class="'+w+'prev">'+this.svg+"</span>")+'<span class="'+w+'switch">'+a[0]+'</span>\t\t</div>\t\t<div class="'+w+'half">',h=(h=n<=s&&s<r?h+'<a href="javascript:" class="'+w+'next" data-year="'+s+'">'+this.svg+"</a>":h+'<span class="'+w+'next">'+this.svg+"</span>")+'<span class="'+w+'switch">'+s+"</span>\t\t</div>",h=(h=(h+="</div>")+'<div class="'+l+'body"><div class="'+w+'half">'+i.html+'</div><div class="'+w+'half">'+this._month([s,a[1],a[2]]).html+"</div></div>")+'<div class="'+l+'footer"><a href="javascript:;" class="ui_button ui_button_primary" data-type="ensure">确定</a><a href="javascript:;" class="ui_button" data-type="cancel">取消</a></div>',h+="</div>",this.el.container.attr("data-type","month-range").html(h),this},a.prototype.year=function(){var t=this[x],a=this.el.input,s=a.attr("min")||this.min,i=a.attr("max")||this.max;s="object"==typeof s&&s.getFullYear?s.getFullYear():"string"==typeof s&&0==/\D/.test(s.replace(b,""))?s.toDate().getFullYear():0,i="object"==typeof i&&i.getFullYear?i.getFullYear():"string"==typeof i&&0==/\D/.test(i.replace(b,""))?i.toDate().getFullYear():9999;var e='<div class="'+h+'x">',r=t[0];e=e+'<div class="'+w+'head">',e=s<=r-12&&r-12<=i?e+'<a href="javascript:" class="'+w+'prev" data-year="'+(r-12)+'">'+this.svg+"</a>":e+'<span class="'+w+'prev">'+this.svg+"</span>",e=(e=(e=s<=r+12&&r+12<=i?e+'<a href="javascript:" class="'+w+'next" data-year="'+(r+12)+'">'+this.svg+"</a>":e+'<span class="'+w+'next">'+this.svg+"</span>")+'<span class="'+w+'switch">'+[r-6,r+5].join("-")+"</span></div>")+'<div class="'+h+'body">'+function(){for(var t="",a="",e=r-6;e<r+6;e+=1)a=w+"item",e==r&&(a=a+" "+x),t=s<=e&&e<=i?t+'<a href="javascript:" class="'+a+'">'+e+"</a>":t+'<span class="'+a+'">'+e+"</span>";return t}()+"</div>";var n=(new Date).getFullYear();return e=s<=n&&n<=i?e+'<a href="javascript:" class="'+w+"item "+w+'now">今年</a>':e+'<span class="'+w+"item "+w+'now">今年</span>',e+="</div>",e+="</div>",this.el.container.attr("data-type","year").html(e),this},a.prototype.hour=function(){var i=this[x],t=this.el.input,r=1*t.attr("step");r="hour"!=this.type||!r||r<1?1:Math.round(r);var n=(t.attr("min")||this.min.toString()).split(":")[0],h=(t.attr("max")||this.max.toString()).split(":")[0];/\D/.test(n)?n=0:n*=1,/\D/.test(h)?h=24:h*=1;var a='<div class="'+e+'x">';return a=a+'<div class="'+e+'body">'+function(){for(var t="",a="",e="",s=0;s<24;s+=r)1==(a=s+"").length&&(a="0"+a),e=w+"item",a==i[0]&&(e=e+" "+x),t=n<=a&&a<=h?t+'<a href="javascript:" class="'+e+'">'+a+":00</a>":t+'<span class="'+e+'">'+a+":00</span>";return t}()+"</div>",a+="</div>",this.el.container.attr("data-type","hour").html(a),this},a.prototype.minute=function(){var i=this[x],t=this.el.input,r=1*t.attr("step")||5,n=t.attr("min")||this.min+"",h=t.attr("max")||this.max+"";n="auto"==n||/\D/.test(n.replace(":",""))||2!=n.split(":").length?0:1*n.replace(":",""),h="auto"==h||/\D/.test(h.replace(":",""))||2!=h.split(":").length?2359:1*h.replace(":","");var a='<div class="'+s+'x">',e=1*i[0];return a=a+'<div class="'+w+'head">',a=e<=Math.floor(n/100)?a+'<span class="'+w+'prev">'+this.svg+"</span>":a+'<a href="javascript:" class="'+w+'prev" data-hour="'+(e-1)+'">'+this.svg+"</a>",a=(a=(a=e>=Math.floor(h/100)?a+'<span class="'+w+'next">'+this.svg+"</span>":a+'<a href="javascript:" class="'+w+'next" data-hour="'+(e+1)+'">'+this.svg+"</a>")+'<a href="javascript:" class="'+w+'switch" data-type="hour">'+i[0]+":00</a></div>")+'<div class="'+s+'body">'+function(){for(var t="",a="",e="",s=0;s<60;s+=r)1==(a=s+"").length&&(a="0"+a),e=w+"item",1*(i[0]+a)>=n&&1*(i[0]+a)<=h?(a==i[1]&&(e=e+" "+x),t=t+'<a href="javascript:" class="'+e+'">'+[i[0],a].join(":")+"</a>"):t=t+'<span class="'+e+'">'+[i[0],a].join(":")+"</span>";return t}()+"</div>",a+="</div>",this.el.container.attr("data-type","minute").html(a),this},a.prototype.show=function(){var t=this.el.container;this.format(),"time"==this.type?this.minute():"date-range"==this.type?(this._rangeSelected||(this._rangeSelected=this[x]),this["date-range"]()):"month-range"==this.type?(this._rangeSelected||(this._rangeSelected=this[x]),this["month-range"]()):this[this.type]?this[this.type]():this.date(),0==$.contains($(document.body),t)&&$(document.body).append(t),t.show().follow(this.el.trigger.addClass(i),{position:"4-1"});var a=this.el.input.parents(".modal");return 0<a.size()&&t.css({"z-index":Number(a.css("z-index"))+1}),$.isFunction(this.callback.show)&&this.callback.show.call(this,this.el.input,t),this.display=!0,this},a.prototype.hide=function(){return this.el.container.hide(),this.el.trigger.removeClass(i),$.isFunction(this.callback.hide)&&this.callback.hide.call(this,this.el.input,this.el.container),this.display=!1,this},$.fn.dateTime=function(t){return $(this).each(function(){$(this).data("dateTime",new a($(this),t))})},a});